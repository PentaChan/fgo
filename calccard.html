<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <link href="css/style.css" rel="stylesheet" />

</head>
<body id="content">
    <div id="showSkillsWin" class="showSkills"><a id="btnClose" class="close" href="javascript:void(0)">☒</a></div>
    <div id="divServant">
        <table>
            <tr>
                <td colspan="6">
                    <select id="ddlChooseServant">
                        <option value="-1">|----------------------请选择从者-------------------------|</option>
                    </select>
                    <input type="text" id="txtWord" autocomplete="on"/>
                    <input type="button" id="btnSearch" value="查询" />&nbsp;
                    <a href="javascript:void(0)" id="btnShowSkills">从者技能详情</a>&nbsp;
                    <a href="javascript:void(0)" id="btnRedirectKazemai">前往理想鄉</a>&nbsp;
                    <a href="javascript:void(0)" id="btnRedirectWiki">前往wiki</a>&nbsp;
                </td>
            </tr>
            <tr>
                <td>阵营</td>
                <td colspan="5" style="text-align: center; font-weight: bold;"><span id="spanCamp"></span></td>
            </tr>
            <tr>
                <td>攻击力</td>
                <td>
                    <input type="text" id="txtAttack" />
                </td>
                <td>强化芙芙Atk</td>
                <td>
                    <input type="text" id="txtFufuAtk" value="0" />
                </td>
                <td>礼装Atk</td>
                <td>
                    <input type="text" id="txtCardAtk" value="0" />
                </td>
            </tr>

            <tr>
                <td>配卡</td>
                <td colspan="5">
                    <div id="divCards" class="cards"></div>
                </td>
            </tr>

            <tr>
                <td>首卡颜色
                </td>
                <td>
                    <select id="ddlFirstCardColor">
                        <option value="0">非红色</option>
                        <option value="0.5">红色</option>
                    </select>
                </td>
                <td>卡色</td>
                <td>
                    <select id="ddlCardColor">
                        <option value="0.8" type="">Quick</option>
                        <option value="1.0" type="">Arts</option>
                        <option value="1.5" type="">Buster</option>
                        <option value="1.0" type="ea1">Extra Attack</option>
                        <option value="1.0" type="ea2">Extra Attack(前3张卡同色)</option>
                    </select>
                </td>
                <td>卡位</td>
                <td>
                    <select id="ddlCardPosition">
                        <option value="1.0" type="">一位</option>
                        <option value="1.2" type="">二位</option>
                        <option value="1.4" type="">三位</option>
                        <option value="1.0" type="ea">四位(Extra Attack)</option>
                    </select>
                </td>


            </tr>
            <tr>
                <td>职介克制</td>
                <td>
                    <select id="ddlCareerResist">
                        <option value="1.0">非克制</option>
                        <option value="2.0">普通克制</option>
                        <option value="1.5">狂阶克制</option>
                        <option value="0.5">被克制</option>
                        <option value="1.2">克制Beast III</option>
                        <option value="1.5">Altergo克制下三骑</option>
                    </select>
                </td>
                <td>阵营克制</td>
                <td>
                    <select id="ddlCampResist">
                        <option value="1.1">克制</option>
                        <option value="1.0">非克制</option>
                        <option value="0.9">被克制</option>
                    </select>
                </td>
                <td>从者职介</td>
                <td>
                    <select id="ddlCareer">
                        <option value="1.00">Saber</option>
                        <option value="0.95">Archer</option>
                        <option value="1.05">Lancer</option>
                        <option value="1.0">Rider</option>
                        <option value="0.9">Caster</option>
                        <option value="0.9">Assassin</option>
                        <option value="1.1">Berserker</option>
                        <option value="1.1">Ruler</option>
                        <option value="1.1">Avenger</option>
                        <option value="1.0">Shielder</option>
                        <option value="1.0">MoonCancer</option>
                        <option value="1.0">Altergo</option>
                    </select>
                </td>
            </tr>


            <tr>
                <td>卡牌Buff(%)</td>
                <td>
                    <input type="text" id="txtCardBuff" value="0" />
                </td>
                <td>攻击力Buff(%)</td>
                <td>
                    <input type="text" id="txtAttackBuff" value="0" />
                </td>
                <td>敌方防御力Buff(%)</td>
                <td>
                    <input type="text" id="txtEnemyDefenceBuff" value="0" />
                </td>
            </tr>
            <tr>
                <td>特攻威力Buff(%)</td>
                <td>
                    <input type="text" id="txtSpecialAttackPowerBuff" value="0" />
                </td>
                <td>敌方特防威力Buff(%)</td>
                <td>
                    <input type="text" id="txtSpecialDefencePowerBuff" value="0" />
                </td>
                <td>固定伤害Buff</td>
                <td>
                    <input type="text" id="txtFixedDamageBuff" value="0" />
                </td>

            </tr>
            <tr>
                <td>敌方固定减伤Buff</td>
                <td>
                    <input type="text" id="txtEnemyFixedDamageReductionBuff" value="0" />
                </td>
                <td>
                    <label for="ckIsBusterChain">Buster Chain加成<input type="checkbox" id="ckIsBusterChain" /></label></td>
                <td style="text-align: center">
                    <label for="ckIsCritical">暴击<input type="checkbox" id="ckIsCritical" /></label>

                </td>
                <td>暴击威力Buff(%)</td>
                <td>
                    <input type="text" id="txtCritialPowerBuff" value="0" data-value="0" /></td>

            </tr>
            <tr>
                <td colspan="6">
                    <input type="button" value="计算" id="btnCalcute" onclick="calc()" />
                    <label for="ckIsCalcTotal">计算总伤害<input type="checkbox" id="ckIsCalcTotal" /></label>
                </td>
            </tr>
        </table>
    </div>
    <br />

    <div id="divResult">
        <b>结果：<a href="javascript:void(0)" onclick="clearTable(1)">清空</a></b>
        <table id="tbResult">
            <tr>
                <th>排名</th>
                <th>从者</th>
                <th>ATK</th>
                <th>首卡颜色</th>
                <th>卡色</th>
                <th>卡位</th>
                <th>卡牌Buff</th>
                <th>攻击力Buff</th>
                <th>特攻威力Buff</th>
                <th>敌方防御力Buff</th>
                <th>Buster Chain</th>
                <th>暴击</th>
                <th>暴击威力Buff</th>
                <th>最小值 </th>
                <th>最大值</th>
                <th>平均值</th>
                <th>&nbsp;</th>
            </tr>
        </table>
    </div>
</body>
</html>
<script src="js/data.js"></script>
<script src="js/common.js"></script>
<script src="js/base.js"></script>
<script type="text/javascript">
    /****************************************************************************/
    intialData();
    intialServantList();
    //下拉从者选中项发生变化事件
    $("ddlChooseServant").onchange = function () {
        $("txtCardBuff").setAttribute("data-value", "0");
        $("txtCardBuff").value = 0;

        $("txtCritialPowerBuff").setAttribute("data-value", "0");
        $("ckIsCritical").checked = false;
        $("txtCritialPowerBuff").disabled = true;

        var id = this.value;
        if (id != "-1" && id != "") {
            bindServantData(id);
        }
    }

    //首卡颜色选中项发生变化事件
    $("ddlFirstCardColor").onchange = function () {
        if (getDdlText("ddlCardPosition") == "一位" && getDdlText("ddlFirstCardColor") == "红色") {
            var cardColors = $("ddlCardColor").options;
            for (var i = 0; i < cardColors.length; i++) {
                var cardColor = cardColors[i];
                if (cardColor.text == "Buster") {
                    cardColor.selected = true;
                }
            }
        }
    }

    //卡色选中项发生变化事件
    $("ddlCardColor").onchange = function () {
        var cardEnabled = false;
        if (getDdlAttrText("ddlCardColor", "type") == "ea1" || getDdlAttrText("ddlCardColor", "type") == "ea2") {
            //ex卡不吃卡牌buff
            cardEnabled = true;
            $("txtCardBuff").value = 0;

            $("ddlCardPosition").disabled = true;
            var cardPostions = $("ddlCardPosition").options
            for (var i = 0; i < cardPostions.length; i++) {
                if (cardPostions[i].getAttribute("type") == "ea") {
                    cardPostions[i].selected = true;
                }
            }

        }
        else if (getDdlText("ddlCardColor") == "Buster" && getDdlText("ddlCardPosition") == "一位") {
            $("ddlFirstCardColor").selectedIndex = 1;
            var index = parseInt($("ddlChooseServant").value);
            bindServantCareerSkillInfo(servants[index]);
        }
        else {
            $("ddlCardPosition").disabled = false;
            if (getDdlAttrText("ddlCardPosition", "type") == "ea") {
                $("ddlCardPosition").selectedIndex = 0;
            }
            var index = parseInt($("ddlChooseServant").value);
            bindServantCareerSkillInfo(servants[index]);
        }
        $("txtCardBuff").disabled = cardEnabled;
    }

    //卡位选中项发生变化事件
    $("ddlCardPosition").onchange = function () {
        var cardEnabled2 = false;
        if (getDdlAttrText("ddlCardPosition", "type") == "ea") {
            //ex卡不吃卡牌buff
            cardEnabled2 = true;
            $("txtCardBuff").value = 0;

            if (getDdlAttrText("ddlCardColor", "type") != "ea1" && getDdlAttrText("ddlCardColor", "type") != "ea2") {
                alert("请在卡色处选择Extra Attack");
                $("ddlCardPosition").selectedIndex = 0;
                cardEnabled2 = false;
                var index = parseInt($("ddlChooseServant").value);
                bindServantCareerSkillInfo(servants[index]);
            }

        }
        $("txtCardBuff").disabled = cardEnabled2;
    }

    //暴击
    $("txtCritialPowerBuff").disabled = $("ckIsCritical").checked ? false : true;
    $("ckIsCritical").onchange = function () {
        if ($("ckIsCritical").checked) {//暴击
            $("txtCritialPowerBuff").disabled = false;
            $("txtCritialPowerBuff").value = getTxtAttrFloatNum("txtCritialPowerBuff", "data-value");
        }
        else {//不暴击
            $("txtCritialPowerBuff").disabled = true;
            $("txtCritialPowerBuff").value = 0;
        }
    }


    /****************************************************************************/

    //绑定从者基本信息
    function bindServantData(id) {
        var servant = servants[id];
        //0.阵营
        $("spanCamp").innerHTML = servant.camp;

        //1.攻击力
        $("txtAttack").value = servant.atk;

        //2.从者职介
        var careers = $("ddlCareer").options;
        for (var i = 0; i < careers.length; i++) {
            var career = careers[i];
            if (career.text == servant.career) {
                career.selected = true;
            }
        }

        //3.职介技能
        bindServantCareerSkillInfo(servant);

        //4.配卡
        var cardsStr = servant.cards;
        if (cardsStr && cardsStr.length == 5) {//ABBBQ
            var cardHtml = getCardsHtml(cardsStr);
            $("divCards").innerHTML = cardHtml;
        }

    }

    //绑定从者职介信息
    function bindServantCareerSkillInfo(servant) {
        //{ cardColor: 1, cardBuff: 10, fixedDamageBuff: 0, critialPowerBuff: 0 }
        var careerSkill = servant.careerSkill;

        if (careerSkill) {
            var cardColorValue = getFloat("ddlCardColor");
            var cardBuffs = careerSkill.cardBuff;
            if (isNaN(cardBuffs)) {//"12|11"
                cardBuffs = careerSkill.cardBuff.split('|');
            }

            var cardColor = careerSkill.cardColor;
            /************************************卡牌Buff******************************************************/
            //0.8(Quick)，1(Arts)，1.5(Buster)，0(All)，-1(None)，-2(Quick和Arts)，-3(Buster和Quick)
            if ((cardColor == 0.8 || cardColor == 1 || cardColor == 1.5) && cardColor == cardColorValue) {
                $("txtCardBuff").setAttribute("data-value", careerSkill.cardBuff);
                $("txtCardBuff").value = careerSkill.cardBuff;
            }
            else if (cardColor == 0) {//215
                $("txtCardBuff").setAttribute("data-value", careerSkill.cardBuff);
                $("txtCardBuff").value = careerSkill.cardBuff;
            }
                //Quick和Arts
            else if (cardColor == -2 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                var quickBuff = cardBuffs[0];
                $("txtCardBuff").setAttribute("data-value", quickBuff);
                $("txtCardBuff").value = quickBuff;
            }
            else if (cardColor == -2 && cardColorValue == 1 && cardBuffs && cardBuffs.length == 2) {
                var artsBuff = cardBuffs[1];
                $("txtCardBuff").setAttribute("data-value", artsBuff);
                $("txtCardBuff").value = artsBuff;
            }
                //Buster和Quick
            else if (cardColor == -3 && cardColorValue == 1.5 && cardBuffs && cardBuffs.length == 2) {
                var busterBuff = cardBuffs[0];
                $("txtCardBuff").setAttribute("data-value", busterBuff);
                $("txtCardBuff").value = busterBuff;
            }
            else if (cardColor == -3 && cardColorValue == 0.8 && cardBuffs && cardBuffs.length == 2) {
                var quickBuff = cardBuffs[1];
                $("txtCardBuff").setAttribute("data-value", quickBuff);
                $("txtCardBuff").value = quickBuff;
            }
            else {
                $("txtCardBuff").setAttribute("data-value", 0);
                $("txtCardBuff").value = 0;
            }
            /****************************************固定伤害Buff**************************************************/
            if (!isNaN(careerSkill.fixedDamageBuff)) {
                $("txtFixedDamageBuff").value = careerSkill.fixedDamageBuff;
            }

            /****************************************暴击威力Buff**************************************************/
            if (!$("ckIsCritical").checked) {
                $("txtCritialPowerBuff").value = 0;
            }
            else {
                $("txtCritialPowerBuff").value = careerSkill.critialPowerBuff;
            }
            $("txtCritialPowerBuff").setAttribute("data-value", careerSkill.critialPowerBuff);
        }

    }

    function intialServantList() {
        for (var key in servants) {
            if (isNaN(key)) {
                return;
            }
            var item = servants[key];
            $("ddlChooseServant").options.add(new Option("【" + item.career + "】" + item.name, item.id));
        }
    }



    var resultArr = new Array();
    var rankIndex = 0;
    var guid = 0;
    //计算指令卡伤害
    function calc() {
        if ($("ddlChooseServant").value == "-1") {
            alert("请选择从者")
            return;
        }
        guid++;
        //1.攻击力
        var attack = getFloat("txtAttack");

        //2.强化芙芙Atk
        var fufuAtk = getFloat("txtFufuAtk");

        //3.礼装Atk
        var cardAtk = getFloat("txtCardAtk");

        attack += fufuAtk + cardAtk;

        //4.首卡颜色
        var firstCardColor = getFloat("ddlFirstCardColor");

        //5.卡色
        var cardColor = getFloat("ddlCardColor");

        //6.卡位
        var cardPostion = getFloat("ddlCardPosition");

        //7.职介克制
        var careerResist = getFloat("ddlCareerResist");

        //8.阵营克制
        var campResist = getFloat("ddlCampResist");

        //9.从者职介 
        var career = getFloat("ddlCareer");

        //10.卡牌Buff(%)
        var cardBuff = getFloat("txtCardBuff") / 100;

        //11.攻击力Buff(%)
        var attackBuff = getFloat("txtAttackBuff") / 100;

        //12.敌方防御力Buff(%)
        var enemyDefenceBuff = getFloat("txtEnemyDefenceBuff") / 100;

        //13.特攻威力Buff(%)
        var specialAttackPowerBuff = getFloat("txtSpecialAttackPowerBuff") / 100;

        //14.敌方特防威力Buff(%)
        var specialDefencePowerBuff = getFloat("txtSpecialDefencePowerBuff") / 100;

        //15.固定伤害Buff
        var fixedDamageBuff = getFloat("txtFixedDamageBuff");

        //16.敌方固定减伤Buff
        var enemyFixedDamageReductionBuff = getFloat("txtEnemyFixedDamageReductionBuff");

        //17.暴击威力BUFF
        var critialPowerBuff = getFloat("txtCritialPowerBuff") / 100;

        //18.EX攻击奖励
        var exAttackReward = 1;

        if (getDdlAttrText("ddlCardColor", "type") == "ea1") {//不同色
            exAttackReward = 2.0;
        }
        else if (getDdlAttrText("ddlCardColor", "type") == "ea2") {//同色
            exAttackReward = 3.5;
        }

        //19.Buster Chain加成
        var busterChain = 0;
        if ($("ckIsBusterChain").checked) {
            busterChain = 0.2;
        }

        //20.暴击补正：暴击时计算此项。为定值[2.0]。
        var critialCorrection = 1.0;
        if ($("ckIsCritical").checked) {
            critialCorrection = 2.0;
        }
        /*
           ATK×攻击补正(0.23)×[卡牌伤害倍率×位置加成×(1+卡牌BUFF)+首位加成]×职阶补正×职阶相性补正×阵营相性补正×乱数补正×(1+攻击力BUFF—敌方防御力BUFF—敌方特防威力BUFF)×(1+特攻威力BUFF+暴击威力BUFF)×暴击补正×EX攻击奖励
 +(固定伤害BUFF—敌方固定伤害BUFF)
 + ATK×Buster Chain加成
        */
        var resultMin = attack * 0.23 * [cardColor * cardPostion * (1 + cardBuff) + firstCardColor] * career * careerResist * campResist * 0.9 * (1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff) * (1 + specialAttackPowerBuff + critialPowerBuff) * critialCorrection * exAttackReward + (fixedDamageBuff - enemyFixedDamageReductionBuff) + attack * busterChain;
        resultMin = Math.floor(resultMin);

        var resultMax = attack * 0.23 * [cardColor * cardPostion * (1 + cardBuff) + firstCardColor] * career * careerResist * campResist * 1.1 * (1 + attackBuff - enemyDefenceBuff - specialDefencePowerBuff) * (1 + specialAttackPowerBuff + critialPowerBuff) * critialCorrection * exAttackReward + (fixedDamageBuff - enemyFixedDamageReductionBuff) + attack * busterChain;
        resultMax = Math.round(resultMax);

        //alert("指令卡伤害：" + resultMin + "~" + resultMax);

        var resultAvg = Math.round((resultMin + resultMax) * 1.0 / 2);

        var servantName = getDdlText("ddlChooseServant");

        var model = {
            guid: guid,
            servantName: servantName,
            atk: attack,
            firstCard: getDdlText("ddlFirstCardColor"),
            cardColor: getDdlText("ddlCardColor"),
            cardPosition: getDdlText("ddlCardPosition"),
            cardBuff: getFloat("txtCardBuff"),
            attackBuff: getFloat("txtAttackBuff"),
            specialAttackPowerBuff: getFloat("txtSpecialAttackPowerBuff"),
            enemyDefenceBuff: getFloat("txtEnemyDefenceBuff"),
            isBusterChain: $("ckIsBusterChain").checked ? "是" : "否",
            isCritial: $("ckIsCritical").checked ? "是" : "否",
            critialPowerBuff: getFloat("txtCritialPowerBuff"),
            min: resultMin,
            max: resultMax,
            avg: resultAvg
        };
        resultArr.push(model);
        showResult();
        reSort();
        calcTotal();
        resizeParentWindow();
    }

    //计算总伤害
    function calcTotal() {
        if (!$("ckIsCalcTotal").checked) {
            return;
        }
        if (!resultArr || resultArr.length <= 0) {
            return;
        }
        var min = 0;
        var max = 0;
        var avg = 0;
        for (var i = 0; i < resultArr.length; i++) {
            min += resultArr[i].min;
            max += resultArr[i].max;
            avg = Math.round((min + max) * 1.0 / 2);
        }

        rankIndex++;

        var tb = document.getElementById("tbResult");
        var newRow = tb.insertRow(-1);
        //1.排名
        var firstCell = newRow.insertCell(-1);
        firstCell.innerHTML = "总伤害";
        firstCell.colSpan = "13";//设置单元格跨13列
        firstCell.align = "center";//居中显示

        //14.指令卡伤害最小值          
        newRow.insertCell(-1).innerHTML = min;
        //15.指令卡伤害最大值          
        newRow.insertCell(-1).innerHTML = max;
        //16.指令卡伤害平均值         
        newRow.insertCell(-1).innerHTML = avg;
        //17.删除操作     
        newRow.insertCell(-1).innerHTML = "&nbsp;"
    }

    //从大到小重新排序
    function reSort() {
        resultArr.sort(compare("avg"));
        clearTable();
        for (var i = 0; i < resultArr.length; i++) {
            createTr(resultArr[i]);
        }
    }

    //删除指定行
    function delTr(obj, guid) {
        for (var i = 0; i < resultArr.length; i++) {
            if (resultArr[i].guid == guid) {
                resultArr.remove(i);
            }
        }
        var deleteRow = obj.parentElement.parentElement;
        deleteRow.parentElement.removeChild(deleteRow);
        reSort();
        calcTotal();
        if (!resultArr || resultArr.length <= 0) {
            hidResult();
        }

        resizeParentWindow();
    }
    //清空table
    function clearTable(obj) {
        if (obj == 1) {
            resultArr.length = 0;
            hidResult();
        }
        rankIndex = 0;
        var tb = document.getElementById("tbResult");
        var len = tb.rows.length
        for (var i = len - 1; i > 0; i--) {
            tb.deleteRow(i);
        }
        resizeParentWindow();
    }
    //新增Tr
    function createTr(obj) {
        rankIndex++;

        var tb = document.getElementById("tbResult");
        var newRow = tb.insertRow(-1);
        //1.排名
        newRow.insertCell(-1).innerHTML = rankIndex;
        //2.从者
        newRow.insertCell(-1).innerHTML = obj.servantName;
        //3.ATK          
        newRow.insertCell(-1).innerHTML = obj.atk;
        //4.首卡颜色
        newRow.insertCell(-1).innerHTML = obj.firstCard;
        //5.卡色
        newRow.insertCell(-1).innerHTML = obj.cardColor;
        //6.卡位
        newRow.insertCell(-1).innerHTML = obj.cardPosition;

        //7.卡牌Buff     
        newRow.insertCell(-1).innerHTML = obj.cardBuff;
        //8.攻击力Buff   
        newRow.insertCell(-1).innerHTML = obj.attackBuff;
        //9.特攻威力Buff 
        newRow.insertCell(-1).innerHTML = obj.specialAttackPowerBuff;

        //10.敌人防御力Buff    
        newRow.insertCell(-1).innerHTML = obj.enemyDefenceBuff;
        //11.Buster Chain
        newRow.insertCell(-1).innerHTML = obj.isBusterChain;
        //12.暴击
        newRow.insertCell(-1).innerHTML = obj.isCritial;
        //13.暴击威力Buff
        newRow.insertCell(-1).innerHTML = obj.critialPowerBuff;

        //14.指令卡伤害最小值          
        newRow.insertCell(-1).innerHTML = obj.min;
        //15.指令卡伤害最大值          
        newRow.insertCell(-1).innerHTML = obj.max;
        //16.指令卡伤害平均值         
        newRow.insertCell(-1).innerHTML = obj.avg;
        //17.删除操作     
        newRow.insertCell(-1).innerHTML = "<a href='javascript:void(0)' onclick='delTr(this," + obj.guid + ")'>删</a>"
    }
    function showResult() {
        showDiv("divResult");
    }
    function hidResult() {
        hideDiv("divResult");
    }

    function showSkillsWin() {
        var id = $("ddlChooseServant").value;
        if (id == "-1") {
            alert("请选择从者");
            return;
        }
        showDiv("showSkillsWin");
        var servant = servants[id];
        var eName = filterStr(servant.eName);
        $("showSkillsWin").style.backgroundImage = "url(images/" + eName + ".png)";
    }
    function hideSkillsWin() {
        hideDiv("showSkillsWin");
    }
</script>
